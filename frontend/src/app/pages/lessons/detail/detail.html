<div class="lesson-detail-content">
  
  <!-- Encabezado de la lecciÃ³n (Solo profesor) -->
  @if (userRole === 'teacher') {
    <div class="lesson-header">
      <div class="lesson-info">
        <h2 class="lesson-title">{{ lesson.title }}</h2>
        <p class="lesson-description">{{ lesson.description }}</p>
        <div class="lesson-meta">
          <span class="meta-item">ğŸ“š {{ lesson.exercises.length }} ejercicios</span>
          <span class="meta-item">â­ +{{ lesson.xp_reward }} XP</span>
          @if (lesson.is_private) {
            <span class="meta-item badge-private">ğŸ” Privada</span>
          }
        </div>
      </div>
      <button class="btn-edit-lesson" (click)="openEditLessonModal()" title="Editar informaciÃ³n de la lecciÃ³n">
        âœï¸ Editar LecciÃ³n
      </button>
    </div>
  } @else {
    <!-- Vista de estudiante (mantener como estaba) -->
    <p class="description">{{ lesson.description }}</p>
  }
  
  <!-- ğŸ†• Badge de lecciÃ³n privada (Solo estudiantes) -->
  @if (userRole !== 'teacher') {
    <div class="lesson-badges">
      @if (lesson.is_private) {
        <span class="badge badge-private">ğŸ” LecciÃ³n Privada (Un solo intento)</span>
      }
    </div>
  }
  
  <!-- ğŸ†• Estado de la lecciÃ³n -->
  @if (lessonStatus(); as status) {
    <div class="lesson-status">
      @if (status.is_locked) {
        <div class="alert alert-locked">
          <strong>ğŸ”’ LecciÃ³n Bloqueada</strong>
          <p>Esta lecciÃ³n privada ya fue completada y no puede volver a realizarse.</p>
          <p><strong>Puntaje obtenido:</strong> {{ status.best_score }} puntos</p>
        </div>
      } @else if (status.is_completed) {
        <div class="alert alert-info">
          <strong>âœ… LecciÃ³n Completada</strong>
          <p><strong>Mejor puntaje:</strong> {{ status.best_score }} puntos</p>
          <p><strong>Intentos realizados:</strong> {{ status.attempt_count }}</p>
          @if (!lesson.is_private) {
            <p class="hint">ğŸ’¡ Puedes volver a intentarla para mejorar tu puntaje</p>
          }
        </div>
      } @else if (lesson.is_private && status.attempt_count === 0) {
        <div class="alert alert-warning">
          <strong>âš ï¸ Advertencia: LecciÃ³n Privada</strong>
          <p>Esta es una lecciÃ³n privada y <strong>solo podrÃ¡s realizarla UNA VEZ</strong>.</p>
          <p>Una vez que completes todos los ejercicios, la lecciÃ³n quedarÃ¡ bloqueada permanentemente.</p>
          <p>AsegÃºrate de estar preparado antes de comenzar.</p>
        </div>
      }
    </div>
  }
  
  <!-- XP Reward (Solo estudiantes) -->
  @if (userRole !== 'teacher') {
    <div class="xp-reward">+{{ lesson.xp_reward }} XP por completar</div>
  }

  <section class="exercises-section">

    @if (userRole === 'teacher') {
      
      @if (editingExercise(); as ex) {
        <div class="edit-form-wrapper">
          <h3>âœï¸ Editando: {{ ex.title }} ({{ ex.type | uppercase }})</h3>
          
          <div class="placeholder-edit-form">
            <p>Formulario de ediciÃ³n para el tipo **{{ ex.type }}** (PENDIENTE: Implementar lÃ³gica de formulario de CRUD).</p>
            <button class="add-button" disabled>Guardar Cambios</button>
            <button class="cancel-button" (click)="cancelEdit()">Cancelar</button>
          </div>
        </div>
      } 
      
      @else {
        <div class="teacher-controls">
          <button class="add-button" (click)="openAddExerciseModal()">
            â• Agregar Nuevo Ejercicio
          </button>
        </div>
        <h3>GestiÃ³n de Ejercicios ({{ lesson.exercises.length }})</h3>
        
        <!-- Vista tipo Game Map de Ejercicios (VERTICAL) -->
        <div class="exercises-game-map">
          @for (exercise of lesson.exercises; track exercise.exercise_uuid; let idx = $index) {
            <div class="exercise-node">
              <div class="exercise-node-content">
                <!-- Icono del tipo de ejercicio -->
                <div class="exercise-icon">
                  @switch (exercise.type) {
                    @case ('question') { <span class="icon">â“</span> }
                    @case ('complete') { <span class="icon">ğŸ“</span> }
                    @case ('make_code') { <span class="icon">ğŸ’»</span> }
                    @case ('study') { <span class="icon">ğŸ“š</span> }
                    @case ('unit_concepts') { <span class="icon">ğŸ”—</span> }
                    @default { <span class="icon">ğŸ“„</span> }
                  }
                </div>
                
                <!-- InformaciÃ³n del ejercicio -->
                <div class="exercise-info">
                  <span class="exercise-number">Ejercicio {{ idx + 1 }}</span>
                  <h4 class="exercise-title">{{ exercise.title }}</h4>
                  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <span class="exercise-type-badge">{{ exercise.type }}</span>
                    <span class="exercise-points">{{ exercise.points }} pts</span>
                  </div>
                </div>
                
                <!-- Botones de acciÃ³n -->
                <div class="exercise-actions">
                  <button class="edit-btn" (click)="startEdit(exercise)" title="Editar ejercicio">
                    âœï¸
                  </button>
                  <button class="delete-btn" (click)="deleteExercise(exercise)" title="Eliminar ejercicio">
                    ğŸ—‘ï¸
                  </button>
                </div>
              </div>
            </div>
            
            <!-- LÃ­nea conectora vertical (excepto despuÃ©s del Ãºltimo) -->
            @if (idx < lesson.exercises.length - 1) {
              <div class="exercise-connector"></div>
            }
          }
          
          <!-- BotÃ³n + al final de la lista -->
          <button class="btn-add-exercise" (click)="openAddExerciseModal()" title="Agregar nuevo ejercicio">
            â•
          </button>
        </div>
      }
    } 
    
    @else {
      <!-- Solo mostrar ejercicios si la lecciÃ³n NO estÃ¡ bloqueada -->
      @if (lessonStatus() && !lessonStatus()!.is_locked) {
        <app-exercise-container 
          [exercises]="lesson.exercises"
          [lessonId]="lesson._id"
          [moduleId]="moduleId"
        ></app-exercise-container>
      } @else if (lessonStatus() && lessonStatus()!.is_locked) {
        <div class="locked-message">
          <p>ğŸ”’ No puedes acceder a los ejercicios de una lecciÃ³n privada bloqueada.</p>
          <button class="back-button" (click)="cancelStartExam()">â† Volver al MÃ³dulo</button>
        </div>
      }
    }
  </section>
</div>

<!-- Modal de Agregar/Editar Ejercicio -->
@if (showAddExerciseModal()) {
  <app-exercise-creator-modal
    [moduleId]="moduleId"
    [lessonId]="lesson._id"
    [exerciseToEdit]="exerciseToEdit()"
    (close)="closeAddExerciseModal()"
    (exerciseCreated)="onExerciseCreated()"
  />
}
<!-- Modal de Editar LecciÃ³n -->
@if (showEditLessonModal()) {
  <app-lesson-edit-modal
    [lessonToEdit]="lesson"
    (save)="onSaveLessonEdit($event)"
    (close)="closeEditLessonModal()"
  />
}
