<!-- frontend/src/app/pages/game-map/game-map.html -->

<div class="game-map-container">
  
  <!-- ========== PANEL DE ESTUDIANTES (Solo Profesor) ========== -->
  @if (isTeacher()) {
    <app-student-panel />
  }

  <!-- ========== CONTENEDOR PRINCIPAL ========== -->
  <div class="main-content">
    
    <!-- ========== HEADER ========== -->
    <div class="map-header">
      <div class="header-info">
        <h1 class="map-title">ğŸ—ºï¸ Mapa de Aprendizaje</h1>
        @if (currentUser()) {
          <div class="user-info">
            <span class="user-name">ğŸ‘¤ {{ currentUser()!.username }}</span>
            @if (!isTeacher()) {
              <span class="user-xp">â­ {{ currentUser()!.total_points || 0 }} XP</span>
            }
          </div>
        }
      </div>

      <!-- Botones de Profesor -->
      @if (isTeacher()) {
        <div class="teacher-controls">
          <button class="btn btn-stats" (click)="goToTeacherStats()">
            ğŸ“Š EstadÃ­sticas
          </button>
          <button class="btn btn-primary" (click)="onCreateNewModule()">
            â• Crear MÃ³dulo
          </button>
        </div>
      }

      <!-- BotÃ³n de Estudiante -->
      @if (!isTeacher()) {
        <div class="teacher-controls">
          <button class="btn btn-student-stats" (click)="goToStudentDashboard()">
            ğŸ¯ Mi Progreso
          </button>
        </div>
      }
    </div>

    <!-- ========== ESTADOS DE CARGA ========== -->
    
    @if (isLoading()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Cargando mÃ³dulos...</p>
      </div>
    }

    @if (error()) {
      <div class="error-state">
        <p class="error-message">âŒ {{ error() }}</p>
        <button class="btn btn-secondary" (click)="loadModules()">
          ğŸ”„ Reintentar
        </button>
      </div>
    }

    <!-- ========== GRID DE MÃ“DULOS ========== -->
    
    @if (!isLoading() && !error() && modules().length > 0) {
      <div class="modules-grid">
        @for (module of modules(); track module._id) {
          <app-module-node
            [module]="module"
            [isTeacher]="isTeacher()"
            (lessonClick)="isTeacher() 
              ? onLessonClickTeacher(module._id, $event.lessonId, $event.lessonIndex)
              : onLessonClickStudent(module._id, $event.lessonId)"
            (addLesson)="onAddLessonToModule(module._id)"
            (editModule)="onEditModule(module._id)"
            (deleteModule)="onDeleteModule(module._id, module.title)"
          />
        }
      </div>
    }

    @if (!isLoading() && !error() && modules().length === 0) {
      <div class="empty-state">
        <p>ğŸ“š No hay mÃ³dulos disponibles todavÃ­a.</p>
        @if (isTeacher()) {
          <button class="btn btn-primary" (click)="onCreateNewModule()">
            Crear el primer mÃ³dulo
          </button>
        }
      </div>
    }

  </div>

  <!-- ========== MODAL DE CREACIÃ“N DE MÃ“DULO ========== -->
  @if (showModuleFormModal()) {
    <app-module-form-modal
      (close)="onCloseModuleFormModal()"
      (moduleCreated)="onModuleCreated()"
    />
  }

  <!-- ========== MODAL DE EDICIÃ“N DE MÃ“DULO ========== -->
  @if (showModuleEditModal() && moduleToEdit()) {
    <app-module-edit-modal
      [moduleToEdit]="moduleToEdit()"
      (save)="onSaveModuleEdit($event)"
      (close)="onCloseModuleEditModal()"
    />
  }

  <!-- ========== MODAL DE LECCIÃ“N ========== -->
  @if (showLessonFormModal() && editingModuleId()) {
    <app-lesson-form-modal
      [moduleId]="editingModuleId()!"
      (close)="onCloseLessonFormModal()"
      (lessonCreated)="onLessonSaved()"
    />
  }

</div>
