<!-- frontend/src/app/pages/teacher-stats/teacher-stats.html -->

<div class="teacher-stats-container">
  
  <!-- Header -->
  <div class="stats-header">
    <div class="header-left">
      <button class="btn-back" (click)="goBack()">
        â† Volver al Mapa
      </button>
    </div>
    <div class="header-center">
      <h1>ğŸ“Š EstadÃ­sticas de Estudiantes</h1>
      <p class="subtitle">Vista general del progreso de todos los alumnos</p>
    </div>
    <div class="header-right">
      <button class="btn-rewards" (click)="goToRewards()">
        ğŸ Gestionar Recompensas
      </button>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Cargando estadÃ­sticas...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="error-container">
      <p class="error-message">{{ error() }}</p>
      <button class="btn-retry" (click)="loadStats()">Reintentar</button>
    </div>
  }

  <!-- Main Content -->
  @if (!isLoading() && !error()) {
    
    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-icon">ğŸ‘¥</div>
        <div class="card-content">
          <span class="card-value">{{ students().length }}</span>
          <span class="card-label">Estudiantes</span>
        </div>
      </div>

      <div class="summary-card">
        <div class="card-icon">âœ…</div>
        <div class="card-content">
          <span class="card-value">
            {{ getTotalLessonsCompleted() }}
          </span>
          <span class="card-label">Lecciones Completadas</span>
        </div>
      </div>

      <div class="summary-card">
        <div class="card-icon">â­</div>
        <div class="card-content">
          <span class="card-value">
            {{ getTotalXP() }}
          </span>
          <span class="card-label">XP Total</span>
        </div>
      </div>

      <div class="summary-card">
        <div class="card-icon">ğŸ”¥</div>
        <div class="card-content">
          <span class="card-value">
            {{ getActiveStreaksCount() }}
          </span>
          <span class="card-label">Con Racha Activa</span>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls-section">
      <!-- Search -->
      <div class="search-box">
        <input
          type="text"
          placeholder="ğŸ” Buscar por nombre o email..."
          [(ngModel)]="searchTerm"
          [ngModelOptions]="{standalone: true}"
          class="search-input"
        />
      </div>

      <!-- Sort Buttons -->
      <div class="sort-buttons">
        <button
          class="sort-btn"
          [class.active]="sortBy() === 'xp'"
          (click)="setSortBy('xp')">
          â­ XP
          @if (sortBy() === 'xp') {
            <span class="sort-arrow">{{ sortDirection() === 'asc' ? 'â†‘' : 'â†“' }}</span>
          }
        </button>
        <button
          class="sort-btn"
          [class.active]="sortBy() === 'streak'"
          (click)="setSortBy('streak')">
          ğŸ”¥ Racha
          @if (sortBy() === 'streak') {
            <span class="sort-arrow">{{ sortDirection() === 'asc' ? 'â†‘' : 'â†“' }}</span>
          }
        </button>
        <button
          class="sort-btn"
          [class.active]="sortBy() === 'lessons'"
          (click)="setSortBy('lessons')">
          ğŸ“š Lecciones
          @if (sortBy() === 'lessons') {
            <span class="sort-arrow">{{ sortDirection() === 'asc' ? 'â†‘' : 'â†“' }}</span>
          }
        </button>
        <button
          class="sort-btn"
          [class.active]="sortBy() === 'name'"
          (click)="setSortBy('name')">
          ğŸ“ Nombre
          @if (sortBy() === 'name') {
            <span class="sort-arrow">{{ sortDirection() === 'asc' ? 'â†‘' : 'â†“' }}</span>
          }
        </button>
      </div>
    </div>

    <!-- Students Table -->
    <div class="students-table-container">
      @if (getFilteredStudents().length === 0) {
        <div class="empty-state">
          <p>No se encontraron estudiantes con ese criterio</p>
        </div>
      } @else {
        <table class="students-table">
          <thead>
            <tr>
              <th>Estudiante</th>
              <th>â­ XP Total</th>
              <th>ğŸ”¥ Racha</th>
              <th>ğŸ“š Lecciones</th>
              <th>âœï¸ Ejercicios</th>
              <th>ğŸ“… DÃ­as Activos</th>
              <th>ğŸ•’ Ãšltima Actividad</th>
              <th>ğŸ“Š Progreso</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (student of getFilteredStudents(); track student.user_id) {
              <tr class="student-row" (click)="selectStudent(student)">
                <td class="student-info">
                  <div class="student-avatar">{{ student.username.charAt(0).toUpperCase() }}</div>
                  <div class="student-details">
                    <span class="student-name">{{ student.username }}</span>
                    <span class="student-email">{{ student.email }}</span>
                  </div>
                </td>
                <td class="stat-cell">
                  <span class="stat-value xp">{{ student.total_xp }}</span>
                </td>
                <td class="stat-cell">
                  <span class="stat-value streak" [class.active]="student.streak_days > 0">
                    {{ student.streak_days }} dÃ­as
                  </span>
                </td>
                <td class="stat-cell">
                  <span class="stat-value">{{ student.lessons_completed }}</span>
                </td>
                <td class="stat-cell">
                  <span class="stat-value">{{ student.exercises_completed }}</span>
                </td>
                <td class="stat-cell">
                  <span class="stat-value">{{ student.active_days_count }}</span>
                </td>
                <td class="stat-cell">
                  <span class="stat-value-small">{{ formatDate(student.last_activity) }}</span>
                </td>
                <td class="stat-cell">
                  <div class="progress-bar-container">
                    <div 
                      class="progress-bar-fill" 
                      [style.width.%]="getAverageProgress(student)">
                    </div>
                    <span class="progress-text">{{ getAverageProgress(student) }}% {{ student.global_progress_text ? '(' + student.global_progress_text + ')' : '' }}</span>
                  </div>
                </td>
                <td class="actions-cell">
                  <button 
                    class="btn-details" 
                    (click)="selectStudent(student); $event.stopPropagation()"
                    title="Ver detalles">
                    ğŸ‘ï¸
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      }
    </div>

  }

  <!-- Detail Panel (Sidebar) -->
  @if (selectedStudent()) {
    <div class="detail-panel-backdrop" (click)="closeDetails()">
      <div class="detail-panel" (click)="$event.stopPropagation()">
        
        <!-- Panel Header -->
        <div class="panel-header">
          <h2>{{ selectedStudent()!.username }}</h2>
          <button class="btn-close-panel" (click)="closeDetails()">âœ•</button>
        </div>

        <!-- Panel Content -->
        <div class="panel-content">
          
          <!-- User Info -->
          <div class="info-section">
            <h3>InformaciÃ³n General</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Email:</span>
                <span class="info-value">{{ selectedStudent()!.email }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">XP Total:</span>
                <span class="info-value">{{ selectedStudent()!.total_xp }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Racha:</span>
                <span class="info-value">{{ selectedStudent()!.streak_days }} dÃ­as ğŸ”¥</span>
              </div>
              <div class="info-item">
                <span class="info-label">Lecciones Completadas:</span>
                <span class="info-value">{{ selectedStudent()!.lessons_completed }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Ejercicios Completados:</span>
                <span class="info-value">{{ selectedStudent()!.exercises_completed }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">DÃ­as Activos:</span>
                <span class="info-value">{{ selectedStudent()!.active_days_count }}</span>
              </div>
            </div>
          </div>

          <!-- Activity Calendar -->
          <div class="info-section">
            <h3>ğŸ“… DÃ­as de Actividad Recientes</h3>
            <div class="activity-calendar">
              @for (day of selectedStudent()!.active_days.slice(0, 10); track day) {
                <div class="activity-day" [title]="day">
                  {{ day }}
                </div>
              }
              @if (selectedStudent()!.active_days.length === 0) {
                <p class="empty-text">No hay actividad registrada</p>
              }
            </div>
          </div>

          <!-- Module Progress -->
          <div class="info-section">
            <h3>ğŸ“š Progreso por MÃ³dulo</h3>
            @for (moduleEntry of selectedStudent()!.modules_progress | keyvalue; track moduleEntry.key) {
              <div class="module-progress-card">
                <div class="module-header">
                  <span class="module-id">MÃ³dulo: {{ moduleEntry.key.substring(0, 8) }}...</span>
                </div>
                <div class="module-stats">
                  <span>âœ… {{ moduleEntry.value.lessons_completed }} lecciones</span>
                  <span>â­ {{ moduleEntry.value.total_score }} puntos</span>
                </div>
              </div>
            }
            @if (Object.keys(selectedStudent()!.modules_progress).length === 0) {
              <p class="empty-text">AÃºn no ha iniciado ningÃºn mÃ³dulo</p>
            }
          </div>

        </div>

      </div>
    </div>
  }

</div>
