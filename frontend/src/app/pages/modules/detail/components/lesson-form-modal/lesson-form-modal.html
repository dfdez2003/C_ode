<!-- frontend/src/app/pages/modules/detail/components/lesson-form-modal/lesson-form-modal.html -->

<div class="modal-backdrop" (click)="onBackdropClick($event)">
  <div class="modal-content">
    
    <!-- Header -->
    <div class="modal-header">
      <h2>‚ûï Agregar Nueva Lecci√≥n</h2>
      <button class="close-button" (click)="onCancel()" [disabled]="isSubmitting()">
        ‚úï
      </button>
    </div>

    <!-- Progress Stepper -->
    <div class="stepper">
      <div class="step" [class.active]="currentStep() === 'lesson'" [class.completed]="currentStep() === 'exercise-selector' || currentStep() === 'exercise-form'">
        <div class="step-number">1</div>
        <div class="step-label">Datos de Lecci√≥n</div>
      </div>
      <div class="step-connector"></div>
      <div class="step" [class.active]="currentStep() === 'exercise-selector' || currentStep() === 'exercise-form'" [class.completed]="exercises().length > 0">
        <div class="step-number">2</div>
        <div class="step-label">Ejercicios</div>
      </div>
    </div>

    <!-- Body -->
    <div class="modal-body">
      
      <!-- Error Message -->
      @if (error()) {
        <div class="error-message">
          ‚ö†Ô∏è {{ error() }}
        </div>
      }

      <!-- PASO 1: DATOS DE LA LECCI√ìN -->
      @if (currentStep() === 'lesson') {
        <form class="lesson-form">
          
          <!-- T√≠tulo -->
          <div class="form-group">
            <label for="lesson-title" class="form-label">
              T√≠tulo de la Lecci√≥n *
            </label>
            <input
              id="lesson-title"
              type="text"
              class="form-input"
              placeholder="Ej: Variables y Tipos de Datos"
              [(ngModel)]="lessonTitle"
              name="lessonTitle"
              [disabled]="isSubmitting()"
              maxlength="100"
              required
            />
            <small class="form-hint">M√≠nimo 3 caracteres</small>
          </div>

          <!-- Descripci√≥n -->
          <div class="form-group">
            <label for="lesson-description" class="form-label">
              Descripci√≥n *
            </label>
            <textarea
              id="lesson-description"
              class="form-textarea"
              placeholder="Describe los conceptos que se aprender√°n en esta lecci√≥n..."
              [(ngModel)]="lessonDescription"
              name="lessonDescription"
              [disabled]="isSubmitting()"
              rows="4"
              maxlength="500"
              required
            ></textarea>
            <small class="form-hint">M√≠nimo 10 caracteres</small>
          </div>

          <!-- XP Reward -->
          <div class="form-group">
            <label for="lesson-xp" class="form-label">
              Recompensa XP
            </label>
            <input
              id="lesson-xp"
              type="number"
              class="form-input"
              [(ngModel)]="lessonXpReward"
              name="lessonXpReward"
              [disabled]="isSubmitting()"
              min="1"
              max="500"
            />
            <small class="form-hint">Puntos de experiencia al completar (1-500)</small>
          </div>

          <!-- Is Private -->
          <div class="form-group-checkbox">
            <label class="checkbox-label">
              <input
                type="checkbox"
                [(ngModel)]="lessonIsPrivate"
                name="lessonIsPrivate"
                [disabled]="isSubmitting()"
              />
              <span>üîí Lecci√≥n Privada</span>
            </label>
            <small class="form-hint">Solo visible para administradores</small>
          </div>

        </form>
      }

      <!-- PASO 2: SELECTOR DE TIPO DE EJERCICIO -->
      @if (currentStep() === 'exercise-selector') {
        <div class="exercise-selector-container">
          
          <h3>Selecciona el tipo de ejercicio</h3>
          
          <!-- Ejercicios ya creados -->
          @if (exercises().length > 0) {
            <div class="exercises-list">
              <h4>‚úÖ Ejercicios creados ({{ exercises().length }})</h4>
              @for (exercise of exercises(); track $index) {
                <div class="exercise-item">
                  <div class="exercise-info">
                    <span class="exercise-type-badge">{{ exercise.type }}</span>
                    <span class="exercise-title">{{ exercise.title }}</span>
                    <span class="exercise-points">{{ exercise.points }} pts</span>
                  </div>
                  <div class="exercise-actions">
                    <button class="btn-icon" (click)="onEditExercise($index)" title="Editar">
                      ‚úèÔ∏è
                    </button>
                    <button class="btn-icon" (click)="onDeleteExercise($index)" title="Eliminar">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              }
            </div>
          }

          <!-- Botones de tipos de ejercicios -->
          <div class="exercise-types-grid">
            
            <button 
              class="exercise-type-card"
              (click)="onExerciseTypeSelected('question')">
              <span class="type-icon">‚ùì</span>
              <span class="type-name">Pregunta</span>
              <span class="type-desc">Pregunta con opciones m√∫ltiples</span>
            </button>

            <button 
              class="exercise-type-card"
              (click)="onExerciseTypeSelected('complete')">
              <span class="type-icon">üìù</span>
              <span class="type-name">Completar</span>
              <span class="type-desc">Completar c√≥digo con opciones</span>
            </button>

            <button 
              class="exercise-type-card"
              (click)="onExerciseTypeSelected('make_code')">
              <span class="type-icon">üíª</span>
              <span class="type-name">Hacer C√≥digo</span>
              <span class="type-desc">Escribir c√≥digo desde cero</span>
            </button>

            <button 
              class="exercise-type-card"
              (click)="onExerciseTypeSelected('study')">
              <span class="type-icon">üìö</span>
              <span class="type-name">Estudiar</span>
              <span class="type-desc">Flashcards de conceptos</span>
            </button>

            <button 
              class="exercise-type-card"
              (click)="onExerciseTypeSelected('unit_concepts')">
              <span class="type-icon">üîó</span>
              <span class="type-name">Unir Conceptos</span>
              <span class="type-desc">Emparejar conceptos y definiciones</span>
            </button>

          </div>

        </div>
      }

      <!-- PASO 3: FORMULARIO DE EJERCICIO -->
      @if (currentStep() === 'exercise-form' && selectedExerciseType()) {
        <div class="exercise-form-container">
          
          @switch (selectedExerciseType()) {
            @case ('question') {
              <app-question-exercise-form
                [exercise]="editingExerciseIndex() !== null ? exercises()[editingExerciseIndex()!] : null"
                (close)="onExerciseBack()"
                (save)="onExerciseSaved($event)"
              />
            }
            @case ('complete') {
              <app-complete-exercise-form
                [exercise]="editingExerciseIndex() !== null ? exercises()[editingExerciseIndex()!] : null"
                (close)="onExerciseBack()"
                (save)="onExerciseSaved($event)"
              />
            }
            @case ('make_code') {
              <app-make-code-exercise-form
                [exercise]="editingExerciseIndex() !== null ? exercises()[editingExerciseIndex()!] : null"
                (close)="onExerciseBack()"
                (save)="onExerciseSaved($event)"
              />
            }
            @case ('study') {
              <app-study-exercise-form
                [exercise]="editingExerciseIndex() !== null ? exercises()[editingExerciseIndex()!] : null"
                (close)="onExerciseBack()"
                (save)="onExerciseSaved($event)"
              />
            }
            @case ('unit_concepts') {
              <app-unit-concepts-exercise-form
                [exercise]="editingExerciseIndex() !== null ? exercises()[editingExerciseIndex()!] : null"
                (close)="onExerciseBack()"
                (save)="onExerciseSaved($event)"
              />
            }
          }

        </div>
      }

    </div>

    <!-- Footer -->
    <div class="modal-footer">
      
      <!-- Botones seg√∫n el paso actual -->
      @if (currentStep() === 'lesson') {
        <button 
          type="button"
          class="btn btn-secondary" 
          (click)="onCancel()">
          Cancelar
        </button>
        <button 
          type="button"
          class="btn btn-primary" 
          (click)="onLessonNext()">
          Siguiente: Agregar Ejercicios ‚Üí
        </button>
      }

      @if (currentStep() === 'exercise-selector') {
        <button 
          type="button"
          class="btn btn-secondary" 
          (click)="onExerciseSelectorBack()">
          ‚Üê Atr√°s
        </button>
        <button 
          type="button"
          class="btn btn-primary" 
          (click)="onFinalize()"
          [disabled]="exercises().length === 0 || isSubmitting()">
          @if (isSubmitting()) {
            <span class="spinner-small"></span>
            Guardando...
          } @else {
            ‚úÖ Finalizar ({{ exercises().length }} ejercicio{{ exercises().length !== 1 ? 's' : '' }})
          }
        </button>
      }

      @if (currentStep() === 'exercise-form') {
        <p class="footer-hint">
          üí° Completa el formulario del ejercicio y haz clic en Guardar
        </p>
      }

    </div>

  </div>
</div>
